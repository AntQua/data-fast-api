============================= test session starts ==============================
platform linux -- Python 3.10.6, pytest-8.2.1, pluggy-1.5.0 -- /home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/bin/python
cachedir: .pytest_cache
rootdir: /home/antqua/code/AntQua/07-ML-Ops/04-Predict-in-production/data-fast-api/tests
configfile: pytest_kitt.ini
plugins: asyncio-0.23.7, anyio-3.7.1
asyncio: mode=strict
collecting ... collected 12 items

tests/api/test_cloud_endpoints.py::test_root_is_up PASSED                [  8%]
tests/api/test_cloud_endpoints.py::test_root_returns_greeting PASSED     [ 16%]
tests/api/test_cloud_endpoints.py::test_predict_is_up PASSED             [ 25%]
tests/api/test_cloud_endpoints.py::test_predict_is_dict PASSED           [ 33%]
tests/api/test_cloud_endpoints.py::test_predict_has_key PASSED           [ 41%]
tests/api/test_cloud_endpoints.py::test_cloud_api_predict PASSED         [ 50%]
tests/api/test_endpoints.py::test_root_is_up PASSED                      [ 58%]
tests/api/test_endpoints.py::test_root_returns_greeting PASSED           [ 66%]
tests/api/test_endpoints.py::test_predict_is_up FAILED                   [ 75%]
tests/api/test_endpoints.py::test_predict_is_dict FAILED                 [ 83%]
tests/api/test_endpoints.py::test_predict_has_key FAILED                 [ 91%]
tests/api/test_endpoints.py::test_predict_val_is_float FAILED            [100%]

=================================== FAILURES ===================================
______________________________ test_predict_is_up ______________________________

self = <starlette.datastructures.State object at 0x7fe5f2db2320>, key = 'model'

    def __getattr__(self, key: typing.Any) -> typing.Any:
        try:
>           return self._state[key]
E           KeyError: 'model'

/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/datastructures.py:701: KeyError

During handling of the above exception, another exception occurred:

    @pytest.mark.asyncio
    async def test_predict_is_up():
        from taxifare.api.fast import app
        async with AsyncClient(app=app, base_url="http://test") as ac:
>           response = await ac.get("/predict", params=test_params)

tests/api/test_endpoints.py:34: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1801: in get
    return await self.request(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1574: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1661: in send
    response = await self._send_handling_auth(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1689: in _send_handling_auth
    response = await self._send_handling_redirects(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1726: in _send_handling_redirects
    response = await self._send_single_request(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1763: in _send_single_request
    response = await transport.handle_async_request(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_transports/asgi.py:164: in handle_async_request
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/applications.py:116: in __call__
    await self.middleware_stack(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:55: in wrapped_app
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:44: in wrapped_app
    await app(scope, receive, sender)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:746: in __call__
    await route.handle(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:75: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:55: in wrapped_app
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:44: in wrapped_app
    await app(scope, receive, sender)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:70: in app
    response = await func(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:299: in app
    raise e
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:193: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/concurrency.py:35: in run_in_threadpool
    return await anyio.to_thread.run_sync(func, *args)
/home/antqua/.pyenv/versions/taxifare-env/lib/python3.10/site-packages/anyio/to_thread.py:33: in run_sync
    return await get_asynclib().run_sync_in_worker_thread(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/anyio/_backends/_asyncio.py:877: in run_sync_in_worker_thread
    return await future
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/anyio/_backends/_asyncio.py:807: in run
    result = context.run(func, *args)
taxifare/api/fast.py:83: in predict
    prediction = app.state.model.predict(X_pred)[0][0]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <starlette.datastructures.State object at 0x7fe5f2db2320>, key = 'model'

    def __getattr__(self, key: typing.Any) -> typing.Any:
        try:
            return self._state[key]
        except KeyError:
            message = "'{}' object has no attribute '{}'"
>           raise AttributeError(message.format(self.__class__.__name__, key))
E           AttributeError: 'State' object has no attribute 'model'

/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/datastructures.py:704: AttributeError
----------------------------- Captured stdout call -----------------------------
[34m
Preprocessing features...[0m
âœ… X_processed, with shape (1, 65)
[34m
Load [Production] model from MLflow...[0m
âœ… Model loaded from MLflow
----------------------------- Captured stderr call -----------------------------
2024-05-30 21:56:11.168861: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library 'libcuda.so.1'; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2024-05-30 21:56:11.169838: W tensorflow/stream_executor/cuda/cuda_driver.cc:263] failed call to cuInit: UNKNOWN ERROR (303)
2024-05-30 21:56:11.169915: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (DESKTOP-3H1SJIF): /proc/driver/nvidia/version does not exist
2024-05-30 21:56:11.171862: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F AVX512_VNNI FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
_____________________________ test_predict_is_dict _____________________________

self = <starlette.datastructures.State object at 0x7fe5f2db2320>, key = 'model'

    def __getattr__(self, key: typing.Any) -> typing.Any:
        try:
>           return self._state[key]
E           KeyError: 'model'

/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/datastructures.py:701: KeyError

During handling of the above exception, another exception occurred:

    @pytest.mark.asyncio
    async def test_predict_is_dict():
        from taxifare.api.fast import app
        async with AsyncClient(app=app, base_url="http://test") as ac:
>           response = await ac.get("/predict", params=test_params)

tests/api/test_endpoints.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1801: in get
    return await self.request(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1574: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1661: in send
    response = await self._send_handling_auth(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1689: in _send_handling_auth
    response = await self._send_handling_redirects(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1726: in _send_handling_redirects
    response = await self._send_single_request(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1763: in _send_single_request
    response = await transport.handle_async_request(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_transports/asgi.py:164: in handle_async_request
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/applications.py:116: in __call__
    await self.middleware_stack(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:55: in wrapped_app
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:44: in wrapped_app
    await app(scope, receive, sender)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:746: in __call__
    await route.handle(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:75: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:55: in wrapped_app
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:44: in wrapped_app
    await app(scope, receive, sender)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:70: in app
    response = await func(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:299: in app
    raise e
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:193: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/concurrency.py:35: in run_in_threadpool
    return await anyio.to_thread.run_sync(func, *args)
/home/antqua/.pyenv/versions/taxifare-env/lib/python3.10/site-packages/anyio/to_thread.py:33: in run_sync
    return await get_asynclib().run_sync_in_worker_thread(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/anyio/_backends/_asyncio.py:877: in run_sync_in_worker_thread
    return await future
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/anyio/_backends/_asyncio.py:807: in run
    result = context.run(func, *args)
taxifare/api/fast.py:83: in predict
    prediction = app.state.model.predict(X_pred)[0][0]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <starlette.datastructures.State object at 0x7fe5f2db2320>, key = 'model'

    def __getattr__(self, key: typing.Any) -> typing.Any:
        try:
            return self._state[key]
        except KeyError:
            message = "'{}' object has no attribute '{}'"
>           raise AttributeError(message.format(self.__class__.__name__, key))
E           AttributeError: 'State' object has no attribute 'model'

/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/datastructures.py:704: AttributeError
----------------------------- Captured stdout call -----------------------------
[34m
Preprocessing features...[0m
âœ… X_processed, with shape (1, 65)
[34m
Load [Production] model from MLflow...[0m
âœ… Model loaded from MLflow
_____________________________ test_predict_has_key _____________________________

self = <starlette.datastructures.State object at 0x7fe5f2db2320>, key = 'model'

    def __getattr__(self, key: typing.Any) -> typing.Any:
        try:
>           return self._state[key]
E           KeyError: 'model'

/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/datastructures.py:701: KeyError

During handling of the above exception, another exception occurred:

    @pytest.mark.asyncio
    async def test_predict_has_key():
        from taxifare.api.fast import app
        async with AsyncClient(app=app, base_url="http://test") as ac:
>           response = await ac.get("/predict", params=test_params)

tests/api/test_endpoints.py:51: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1801: in get
    return await self.request(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1574: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1661: in send
    response = await self._send_handling_auth(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1689: in _send_handling_auth
    response = await self._send_handling_redirects(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1726: in _send_handling_redirects
    response = await self._send_single_request(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1763: in _send_single_request
    response = await transport.handle_async_request(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_transports/asgi.py:164: in handle_async_request
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/applications.py:116: in __call__
    await self.middleware_stack(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:55: in wrapped_app
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:44: in wrapped_app
    await app(scope, receive, sender)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:746: in __call__
    await route.handle(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:75: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:55: in wrapped_app
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:44: in wrapped_app
    await app(scope, receive, sender)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:70: in app
    response = await func(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:299: in app
    raise e
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:193: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/concurrency.py:35: in run_in_threadpool
    return await anyio.to_thread.run_sync(func, *args)
/home/antqua/.pyenv/versions/taxifare-env/lib/python3.10/site-packages/anyio/to_thread.py:33: in run_sync
    return await get_asynclib().run_sync_in_worker_thread(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/anyio/_backends/_asyncio.py:877: in run_sync_in_worker_thread
    return await future
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/anyio/_backends/_asyncio.py:807: in run
    result = context.run(func, *args)
taxifare/api/fast.py:83: in predict
    prediction = app.state.model.predict(X_pred)[0][0]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <starlette.datastructures.State object at 0x7fe5f2db2320>, key = 'model'

    def __getattr__(self, key: typing.Any) -> typing.Any:
        try:
            return self._state[key]
        except KeyError:
            message = "'{}' object has no attribute '{}'"
>           raise AttributeError(message.format(self.__class__.__name__, key))
E           AttributeError: 'State' object has no attribute 'model'

/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/datastructures.py:704: AttributeError
----------------------------- Captured stdout call -----------------------------
[34m
Preprocessing features...[0m
âœ… X_processed, with shape (1, 65)
[34m
Load [Production] model from MLflow...[0m
âœ… Model loaded from MLflow
__________________________ test_predict_val_is_float ___________________________

self = <starlette.datastructures.State object at 0x7fe5f2db2320>, key = 'model'

    def __getattr__(self, key: typing.Any) -> typing.Any:
        try:
>           return self._state[key]
E           KeyError: 'model'

/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/datastructures.py:701: KeyError

During handling of the above exception, another exception occurred:

    @pytest.mark.asyncio
    async def test_predict_val_is_float():
        from taxifare.api.fast import app
        async with AsyncClient(app=app, base_url="http://test") as ac:
>           response = await ac.get("/predict", params=test_params)

tests/api/test_endpoints.py:59: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1801: in get
    return await self.request(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1574: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1661: in send
    response = await self._send_handling_auth(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1689: in _send_handling_auth
    response = await self._send_handling_redirects(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1726: in _send_handling_redirects
    response = await self._send_single_request(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_client.py:1763: in _send_single_request
    response = await transport.handle_async_request(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/httpx/_transports/asgi.py:164: in handle_async_request
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/applications.py:116: in __call__
    await self.middleware_stack(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:55: in wrapped_app
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:44: in wrapped_app
    await app(scope, receive, sender)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:746: in __call__
    await route.handle(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:75: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:55: in wrapped_app
    raise exc
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/_exception_handler.py:44: in wrapped_app
    await app(scope, receive, sender)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/routing.py:70: in app
    response = await func(request)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:299: in app
    raise e
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/fastapi/routing.py:193: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/concurrency.py:35: in run_in_threadpool
    return await anyio.to_thread.run_sync(func, *args)
/home/antqua/.pyenv/versions/taxifare-env/lib/python3.10/site-packages/anyio/to_thread.py:33: in run_sync
    return await get_asynclib().run_sync_in_worker_thread(
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/anyio/_backends/_asyncio.py:877: in run_sync_in_worker_thread
    return await future
/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/anyio/_backends/_asyncio.py:807: in run
    result = context.run(func, *args)
taxifare/api/fast.py:83: in predict
    prediction = app.state.model.predict(X_pred)[0][0]
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <starlette.datastructures.State object at 0x7fe5f2db2320>, key = 'model'

    def __getattr__(self, key: typing.Any) -> typing.Any:
        try:
            return self._state[key]
        except KeyError:
            message = "'{}' object has no attribute '{}'"
>           raise AttributeError(message.format(self.__class__.__name__, key))
E           AttributeError: 'State' object has no attribute 'model'

/home/antqua/.pyenv/versions/3.10.6/envs/taxifare-env/lib/python3.10/site-packages/starlette/datastructures.py:704: AttributeError
----------------------------- Captured stdout call -----------------------------
[34m
Preprocessing features...[0m
âœ… X_processed, with shape (1, 65)
[34m
Load [Production] model from MLflow...[0m
âœ… Model loaded from MLflow
=========================== short test summary info ============================
FAILED tests/api/test_endpoints.py::test_predict_is_up - AttributeError: 'Sta...
FAILED tests/api/test_endpoints.py::test_predict_is_dict - AttributeError: 'S...
FAILED tests/api/test_endpoints.py::test_predict_has_key - AttributeError: 'S...
FAILED tests/api/test_endpoints.py::test_predict_val_is_float - AttributeErro...
============= 4 failed, 8 passed, 20 warnings in 88.10s (0:01:28) ==============
